-- JOBS TABLE
CREATE TABLE Jobs
(
  JobID VARCHAR2(10) PRIMARY KEY,
  JobTitle VARCHAR2(50) NOT NULL,
  MinSalary NUMBER(10,2),
  MaxSalary NUMBER(10,2)
);

-- DEPARTMENTS TABLE
CREATE TABLE Departments
(
  DepartmentID NUMBER PRIMARY KEY,
  DepartmentName VARCHAR2(50) NOT NULL,
  ManagerID NUMBER
);

-- EMPLOYEES TABLE
CREATE TABLE Employees
(
  EmployeeID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  FirstName VARCHAR2(50) NOT NULL,
  LastName VARCHAR2(50) NOT NULL,
  Email VARCHAR2(100),
  PhoneNumber VARCHAR2(20),
  HireDate DATE NOT NULL,
  JobID VARCHAR2(10) NOT NULL,
  Salary NUMBER(10,2) NOT NULL,
  ManagerID NUMBER,
  DepartmentID NUMBER,
  CONSTRAINT fk_job FOREIGN KEY (JobID) REFERENCES Jobs(JobID),
  CONSTRAINT fk_manager FOREIGN KEY (ManagerID) REFERENCES Employees(EmployeeID),
  CONSTRAINT fk_department FOREIGN KEY (DepartmentID) REFERENCES Departments(DepartmentID)
);

-- FOREIGN KEY FOR DEPARTMENTS MANAGER (Self reference to Employees)
ALTER TABLE Departments
ADD CONSTRAINT fk_dept_manager FOREIGN KEY (ManagerID) REFERENCES Employees(EmployeeID);

-- DEDUCTIONS TABLE
CREATE TABLE Deductions
(
  DeductionID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  DeductionName VARCHAR2(100) NOT NULL,
  DeductionType VARCHAR2(20) NOT NULL,    -- 'Percentage' or 'Fixed'
  DeductionValue NUMBER(10,2) NOT NULL,
  IsMandatory CHAR(1) DEFAULT 'Y' CHECK (IsMandatory IN ('Y', 'N')),
  Description VARCHAR2(255)
);

-- SALARY DETAILS TABLE
CREATE TABLE SalaryDetails
(
  SalaryDetailID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EmployeeID NUMBER NOT NULL,
  EffectiveFrom DATE NOT NULL,
  EffectiveTo DATE,
  BaseSalary NUMBER(10,2) NOT NULL,
  Bonus NUMBER(10,2) DEFAULT 0,
  Allowances NUMBER(10,2) DEFAULT 0,
  Deductions NUMBER(10,2) DEFAULT 0,
  CONSTRAINT fk_salary_employee FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID)
);

-- WORK HOURS TABLE
CREATE TABLE WorkHours
(
  WorkHourID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EmployeeID NUMBER NOT NULL,
  WorkDate DATE NOT NULL,
  HoursWorked NUMBER(5,2) NOT NULL,
  OvertimeHours NUMBER(5,2) DEFAULT 0,
  LeaveHours NUMBER(5,2) DEFAULT 0,
  CONSTRAINT fk_workhours_employee FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID)
);

-- PAYROLL TABLE
CREATE TABLE Payroll
(
  PayrollID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EmployeeID NUMBER NOT NULL,
  PayPeriodStart DATE NOT NULL,
  PayPeriodEnd DATE NOT NULL,
  GrossSalary NUMBER(10,2) NOT NULL,
  TaxDeductions NUMBER(10,2) DEFAULT 0,
  OtherDeductions NUMBER(10,2) DEFAULT 0,
  NetSalary NUMBER(10,2) NOT NULL,
  PaymentDate DATE NOT NULL,
  CONSTRAINT fk_payroll_employee FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID)
);

-- ADJUSTMENTS TABLE
CREATE TABLE Adjustments
(
  AdjustmentID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  EmployeeID NUMBER NOT NULL,
  AdjustmentType VARCHAR2(50) NOT NULL,
  Amount NUMBER(10,2) NOT NULL,
  AdjustmentDate DATE NOT NULL,
  Description VARCHAR2(255),
  CONSTRAINT fk_adjustment_employee FOREIGN KEY (EmployeeID) REFERENCES Employees(EmployeeID)
);

-- PAYROLL DEDUCTIONS TABLE
CREATE TABLE PayrollDeductions
(
  PayrollDeductionID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  PayrollID NUMBER NOT NULL,
  DeductionID NUMBER NOT NULL,
  DeductionAmount NUMBER(10,2) NOT NULL,
  CONSTRAINT fk_payrolldeduction_payroll FOREIGN KEY (PayrollID) REFERENCES Payroll(PayrollID),
  CONSTRAINT fk_payrolldeduction_deduction FOREIGN KEY (DeductionID) REFERENCES Deductions(DeductionID)
);

-- SAMPLE DATA INSERTIONS

INSERT INTO Jobs (JobID, JobTitle, MinSalary, MaxSalary) VALUES ('DEV', 'Developer', 30000, 80000);
INSERT INTO Jobs (JobID, JobTitle, MinSalary, MaxSalary) VALUES ('MGR', 'Manager', 50000, 120000);
INSERT INTO Jobs (JobID, JobTitle, MinSalary, MaxSalary) VALUES ('ACC', 'Accountant', 35000, 70000);
INSERT INTO Jobs (JobID, JobTitle, MinSalary, MaxSalary) VALUES ('HR', 'HR Specialist', 30000, 65000);
INSERT INTO Jobs (JobID, JobTitle, MinSalary, MaxSalary) VALUES ('IT', 'IT Support', 25000, 60000);

INSERT INTO Departments (DepartmentID, DepartmentName) VALUES (1, 'Information Technology');
INSERT INTO Departments (DepartmentID, DepartmentName) VALUES (2, 'Human Resources');
INSERT INTO Departments (DepartmentID, DepartmentName) VALUES (3, 'Finance');
INSERT INTO Departments (DepartmentID, DepartmentName) VALUES (4, 'Operations');

-- Employees without CommissionPct as it is not required
INSERT INTO Employees(EmployeeID, FirstName, LastName, Email, PhoneNumber, HireDate, JobID, Salary, ManagerID, DepartmentID)
VALUES (1, 'Libhongo', 'Matokazi', 'libhongo.matokazi@example.com', '011-234-5678', TO_DATE('2015-03-01', 'YYYY-MM-DD'), 'MGR', 90000, NULL, 1);

INSERT INTO Employees(EmployeeID, FirstName, LastName, Email, PhoneNumber, HireDate, JobID, Salary, ManagerID, DepartmentID)
VALUES (2, 'Mavie', 'Smith', 'mavie.smith@example.com', '010-456-8907', TO_DATE('2016-07-15', 'YYYY-MM-DD'), 'MGR', 85000, NULL, 2);

INSERT INTO Employees(EmployeeID, FirstName, LastName, Email, PhoneNumber, HireDate, JobID, Salary, ManagerID, DepartmentID)
VALUES (3, 'Lerato', 'Maphizo', 'lerato.maphizo@example.com', '012-345-6789', TO_DATE('2018-01-10', 'YYYY-MM-DD'), 'DEV', 60000, 1, 1);

INSERT INTO Employees(EmployeeID, FirstName, LastName, Email, PhoneNumber, HireDate, JobID, Salary, ManagerID, DepartmentID)
VALUES (4, 'Smanga', 'Vuyo', 'smanga.vuyo@example.com', '098-765-4321', TO_DATE('2019-05-20', 'YYYY-MM-DD'), 'DEV', 62000, 1, 1);

INSERT INTO Employees(EmployeeID, FirstName, LastName, Email, PhoneNumber, HireDate, JobID, Salary, ManagerID, DepartmentID)
VALUES (5, 'Alex', 'Manly', 'alex.manly@example.com', '096-543-4321', TO_DATE('2017-11-05', 'YYYY-MM-DD'), 'HR', 50000, 2, 2);

INSERT INTO Employees(EmployeeID, FirstName, LastName, Email, PhoneNumber, HireDate, JobID, Salary, ManagerID, DepartmentID)
VALUES (6, 'Caleb', 'Harris', 'caleb.harris@example.com', '098-987-8765', TO_DATE('2020-02-14', 'YYYY-MM-DD'), 'ACC', 55000, 2, 3);

UPDATE Departments SET ManagerID = 1 WHERE DepartmentID = 1;
UPDATE Departments SET ManagerID = 2 WHERE DepartmentID = 2;

-- Deductions
INSERT INTO Deductions (DeductionName, DeductionType, DeductionValue, IsMandatory, Description)
VALUES ('Income Tax', 'Percentage', 15.00, 'Y', 'Mandatory Income Tax Deduction');

INSERT INTO Deductions (DeductionName, DeductionType, DeductionValue, IsMandatory, Description)
VALUES ('Health Insurance', 'Fixed', 200.00, 'Y', 'Monthly Health Insurance Premium');

INSERT INTO Deductions (DeductionName, DeductionType, DeductionValue, IsMandatory, Description)
VALUES ('Retirement Fund', 'Percentage', 5.00, 'Y', 'Mandatory Retirement Contribution');

INSERT INTO Deductions (DeductionName, DeductionType, DeductionValue, IsMandatory, Description)
VALUES ('Union Fees', 'Fixed', 50.00, 'N', 'Optional Union Membership Fees');

-- Salary Details
INSERT INTO SalaryDetails(EmployeeID, EffectiveFrom, EffectiveTo, BaseSalary, Bonus, Allowances, Deductions)
VALUES(3, TO_DATE('2023-01-01', 'YYYY-MM-DD'), NULL, 60000, 5000, 2000, 0);

INSERT INTO SalaryDetails(EmployeeID, EffectiveFrom, EffectiveTo, BaseSalary, Bonus, Allowances, Deductions)
VALUES(4, TO_DATE('2023-01-01', 'YYYY-MM-DD'), NULL, 62000, 4500, 1500, 0);

INSERT INTO SalaryDetails(EmployeeID, EffectiveFrom, EffectiveTo, BaseSalary, Bonus, Allowances, Deductions)
VALUES(5, TO_DATE('2023-01-01', 'YYYY-MM-DD'), NULL, 50000, 0, 1000, 0);

INSERT INTO SalaryDetails(EmployeeID, EffectiveFrom, EffectiveTo, BaseSalary, Bonus, Allowances, Deductions)
VALUES(6, TO_DATE('2023-01-01', 'YYYY-MM-DD'), NULL, 55000, 0, 1200, 0);

-- Work Hours
INSERT INTO WorkHours (EmployeeID, WorkDate, HoursWorked, OvertimeHours, LeaveHours)
VALUES(3, TO_DATE('2025-06-01', 'YYYY-MM-DD'), 8, 2, 0);

INSERT INTO WorkHours (EmployeeID, WorkDate, HoursWorked, OvertimeHours, LeaveHours)
VALUES(3, TO_DATE('2025-06-02', 'YYYY-MM-DD'), 8, 0, 0);

INSERT INTO WorkHours (EmployeeID, WorkDate, HoursWorked, OvertimeHours, LeaveHours)
VALUES(4, TO_DATE('2025-06-01', 'YYYY-MM-DD'), 7.5, 1, 0.5);

INSERT INTO WorkHours (EmployeeID, WorkDate, HoursWorked, OvertimeHours, LeaveHours)
VALUES(5, TO_DATE('2025-06-01', 'YYYY-MM-DD'), 8, 0, 0);

-- Payroll Sample Records
INSERT INTO Payroll (EmployeeID, PayPeriodStart, PayPeriodEnd, GrossSalary, TaxDeductions, OtherDeductions, NetSalary, PaymentDate)
VALUES (3, TO_DATE('2025-06-01', 'YYYY-MM-DD'), TO_DATE('2025-06-15', 'YYYY-MM-DD'), 65000, 9750, 200, 55050, TO_DATE('2025-06-16', 'YYYY-MM-DD'));

INSERT INTO Payroll (EmployeeID, PayPeriodStart, PayPeriodEnd, GrossSalary, TaxDeductions, OtherDeductions, NetSalary, PaymentDate)
VALUES (4, TO_DATE('2025-06-01', 'YYYY-MM-DD'), TO_DATE('2025-06-15', 'YYYY-MM-DD'), 61500, 9225, 200, 52075, TO_DATE('2025-06-16', 'YYYY-MM-DD'));

-- Adjustments
INSERT INTO Adjustments (EmployeeID, AdjustmentType, Amount, AdjustmentDate, Description)
VALUES (3, 'Bonus', 1000, TO_DATE('2025-06-10', 'YYYY-MM-DD'), 'Performance bonus');

INSERT INTO Adjustments (EmployeeID, AdjustmentType, Amount, AdjustmentDate, Description)
VALUES (4, 'Penalty', -200, TO_DATE('2025-06-12', 'YYYY-MM-DD'), 'Late attendance penalty');

-- Payroll Deductions
INSERT INTO PayrollDeductions (PayrollID, DeductionID, DeductionAmount)
VALUES (1, 1, 9750);  -- Income Tax for PayrollID 1

INSERT INTO PayrollDeductions (PayrollID, DeductionID, DeductionAmount)
VALUES (1, 2, 200);   -- Health Insurance for PayrollID 1

INSERT INTO PayrollDeductions (PayrollID, DeductionID, DeductionAmount)
VALUES (2, 1, 9225);  -- Income Tax for PayrollID 2

INSERT INTO PayrollDeductions (PayrollID, DeductionID, DeductionAmount)
VALUES (2, 2, 200);   -- Health Insurance for PayrollID 2;

COMMIT;

-- PROCEDURE TO CALCULATE PAYROLL FOR A SINGLE EMPLOYEE
CREATE OR REPLACE PROCEDURE CalculateEmployeePayroll (
    p_EmployeeID IN NUMBER,
    p_PayPeriodStart IN DATE,
    p_PayPeriodEnd IN DATE
) AS
    v_BaseSalary NUMBER(10,2);
    v_Bonus NUMBER(10,2) := 0;
    v_Allowances NUMBER(10,2) := 0;
    v_Deductions NUMBER(10,2) := 0;
    v_Adjustments NUMBER(10,2) := 0;
    v_GrossSalary NUMBER(10,2);
    v_TaxDeductions NUMBER(10,2) := 0;
    v_OtherDeductions NUMBER(10,2) := 0;
    v_NetSalary NUMBER(10,2);
    v_PayrollID NUMBER;
BEGIN
    -- Get current salary details effective during pay period
    BEGIN
        SELECT BaseSalary, Bonus, Allowances, Deductions
        INTO v_BaseSalary, v_Bonus, v_Allowances, v_Deductions
        FROM SalaryDetails
        WHERE EmployeeID = p_EmployeeID
          AND EffectiveFrom <= p_PayPeriodEnd
          AND (EffectiveTo IS NULL OR EffectiveTo >= p_PayPeriodStart)
          AND ROWNUM = 1;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20001, 'No salary details found for EmployeeID: ' || p_EmployeeID);
    END;

    -- Sum adjustments (bonuses and penalties) during pay period
    SELECT NVL(SUM(Amount), 0)
    INTO v_Adjustments
    FROM Adjustments
    WHERE EmployeeID = p_EmployeeID
      AND AdjustmentDate BETWEEN p_PayPeriodStart AND p_PayPeriodEnd;

    -- Calculate gross salary
    v_GrossSalary := v_BaseSalary + v_Bonus + v_Allowances + v_Adjustments;

    -- Try to find existing Payroll record
    BEGIN
        SELECT PayrollID INTO v_PayrollID
        FROM Payroll
        WHERE EmployeeID = p_EmployeeID
          AND PayPeriodStart = p_PayPeriodStart
          AND PayPeriodEnd = p_PayPeriodEnd;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            v_PayrollID := NULL;
    END;

    -- Calculate deductions only if payroll record exists
    IF v_PayrollID IS NOT NULL THEN
        SELECT NVL(SUM(CASE WHEN d.DeductionType = 'Percentage' THEN pd.DeductionAmount ELSE 0 END), 0),
               NVL(SUM(CASE WHEN d.DeductionType = 'Fixed' THEN pd.DeductionAmount ELSE 0 END), 0)
        INTO v_TaxDeductions, v_OtherDeductions
        FROM PayrollDeductions pd
        JOIN Deductions d ON pd.DeductionID = d.DeductionID
        WHERE pd.PayrollID = v_PayrollID;
    END IF;

    -- Calculate net salary
    v_NetSalary := v_GrossSalary - v_TaxDeductions - v_OtherDeductions - v_Deductions;

    -- Insert or update Payroll record
    IF v_PayrollID IS NULL THEN
        INSERT INTO Payroll (EmployeeID, PayPeriodStart, PayPeriodEnd, GrossSalary, TaxDeductions, OtherDeductions, NetSalary, PaymentDate)
        VALUES (p_EmployeeID, p_PayPeriodStart, p_PayPeriodEnd, v_GrossSalary, v_TaxDeductions, v_OtherDeductions, v_NetSalary, SYSDATE);
    ELSE
        UPDATE Payroll
        SET GrossSalary = v_GrossSalary,
            TaxDeductions = v_TaxDeductions,
            OtherDeductions = v_OtherDeductions,
            NetSalary = v_NetSalary,
            PaymentDate = SYSDATE
        WHERE PayrollID = v_PayrollID;
    END IF;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Error: ' || SQLERRM);
        ROLLBACK;
END CalculateEmployeePayroll;
/

-- PROCEDURE TO PROCESS PAYROLL FOR ALL EMPLOYEES
CREATE OR REPLACE PROCEDURE ProcessPayrollForAllEmployees (
    p_PayPeriodStart IN DATE,
    p_PayPeriodEnd IN DATE
) AS
    CURSOR emp_cur IS
        SELECT EmployeeID FROM Employees;
BEGIN
    FOR emp_rec IN emp_cur LOOP
        BEGIN
            CalculateEmployeePayroll(emp_rec.EmployeeID, p_PayPeriodStart, p_PayPeriodEnd);
            DBMS_OUTPUT.PUT_LINE('Payroll processed for EmployeeID: ' || emp_rec.EmployeeID);
        EXCEPTION
            WHEN OTHERS THEN
                DBMS_OUTPUT.PUT_LINE('Error processing EmployeeID ' || emp_rec.EmployeeID || ': ' || SQLERRM);
        END;
    END LOOP;
END ProcessPayrollForAllEmployees;
/

-- VIEWS FOR REPORTING

CREATE OR REPLACE VIEW EmployeePayrollSummary AS
SELECT
    e.EmployeeID,
    e.FirstName || ' ' || e.LastName AS EmployeeName,
    e.Email,
    e.DepartmentID,
    p.PayPeriodStart,
    p.PayPeriodEnd,
    p.GrossSalary,
    p.TaxDeductions,
    p.OtherDeductions,
    p.NetSalary,
    p.PaymentDate
FROM Employees e
JOIN Payroll p ON e.EmployeeID = p.EmployeeID;

CREATE OR REPLACE VIEW DepartmentSalaryExpense AS
SELECT
    d.DepartmentID,
    d.DepartmentName,
    COUNT(e.EmployeeID) AS NumberOfEmployees,
    SUM(e.Salary) AS TotalSalaryExpense
FROM Departments d
LEFT JOIN Employees e ON d.DepartmentID = e.DepartmentID
GROUP BY d.DepartmentID, d.DepartmentName;

CREATE OR REPLACE VIEW PayrollDeductionsDetail AS
SELECT
    pd.PayrollDeductionID,
    p.PayrollID,
    e.EmployeeID,
    e.FirstName || ' ' || e.LastName AS EmployeeName,
    d.DeductionName,
    pd.DeductionAmount
FROM PayrollDeductions pd
JOIN Payroll p ON pd.PayrollID = p.PayrollID
JOIN Employees e ON p.EmployeeID = e.EmployeeID
JOIN Deductions d ON pd.DeductionID = d.DeductionID;

CREATE OR REPLACE VIEW WorkHoursSummary AS
SELECT
    e.EmployeeID,
    e.FirstName || ' ' || e.LastName AS EmployeeName,
    wh.WorkDate,
    wh.HoursWorked,
    wh.OvertimeHours,
    wh.LeaveHours
FROM WorkHours wh
JOIN Employees e ON wh.EmployeeID = e.EmployeeID;

SELECT*FROM employeepayrollsummary; 

SELECT *FROM employees; 


